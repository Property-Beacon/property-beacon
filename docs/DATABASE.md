# Database

## Prisma

https://www.prisma.io/docs/guides

We define and maintain our data models (**schema**) in `Prisma`, _Node.js_ and _Typescript_, easy to read, less learning curve and type-safe, just like how you define _GraphQL_ schema.

```
├── api
│   ├── schema.prisma
│   ├── seed.js
│   └── migrations
│         ├── migration_lock.toml
│         ├── 20210619042014_added_user_company_models
│         ...
```

`schema.prisma`

The primary schema file to declare database source and data models

```js
datasource db {
  provider = "postgresql"
  // DATABASE_URL is defined in .env
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = "native"
}

enum Role {
  USER
  ADMIN
  CLIENT
  CUSTOMER
}

model User {
  id      String       @id @default(uuid())
  issuer  String       @unique // magic.link unique issuer
  role    Role         @default(USER)
  profile UserProfile?
  email   String
  logOn   DateTime     @default(now())
  logOff  DateTime?
}
```

`seed.js`

This script is mainly to inject dummy data for dev (testing) purpose, change `data` array in the `seed.js` if needed before running data seeding

```bash
yarn rw prisma db seed
```

`migrations` folder

The folder contains auto generated migration scripts, every time we run `yarn rw prisma migrate dev` after schema changes, a migration script will be generated automatically (prompt for filename input is required).

### Change schema

Please make sure you run `yarn rw prisma migrate dev` after you make changes in `schema.prisma`, this will

- create migration script from `schema.prisma` for your changes
- apply them to the database `PostgreSQL`
- generate artifacts

you can also log in [PgAdmin](http://localhost:8080/) to reconfirm you changes are applied to the database if you are not confident.

### ERD

Generated by https://prisma-erd.simonknott.de/.

> TODO: Find a better way (CLI) to generate diagram

<img src="./prisma-erd.svg" alt="Prisma ERD" width="400px" style="background-color:white">

## PostgreSQL

### Local dev

[Local database (PostgreSQL + PgAdmin)](../README.md#local-database-postgresql--pgadmin)

### Staging / Production

_PostgreSQL_ `staging` and `production` are hostedd on [Railway.app](https://railway.app/project/59357b4a-b211-4c84-965d-67b11064d632/plugin/bc6a2c82-f975-4cab-b33b-0ca11a0bdb2d). `staging` is also used for [services unit test](SERVICES.md#unit-test)
